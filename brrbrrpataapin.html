<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBP Coin: Análisis y Gestión de Inversión</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- Carga de Lucide Icons (para íconos) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Configuración de fuente Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fondo oscuro tipo GitHub/Trading terminal */
            color: #c9d1d9; /* Texto claro */
        }
        /* Estilo para los botones de control de gráfico activos */
        .chart-control.active, .scale-control.active {
            opacity: 1;
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
            border: 1px solid white;
        }
        .chart-control, .scale-control {
            opacity: 0.7;
        }
        /* Scrollbar personalizada para la tabla */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #161b22; 
        }
        ::-webkit-scrollbar-thumb {
            background: #30363d; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #58a6ff; 
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Contenedor Principal -->
    <div id="main-container" class="max-w-6xl mx-auto">
        
        <!-- 1. Sección de Acceso a la Plataforma -->
        <section id="login-section" class="flex flex-col items-center justify-center min-h-[80vh] bg-gray-900/50 backdrop-blur-sm rounded-xl shadow-2xl p-8 max-w-lg mx-auto border border-gray-800" role="dialog" aria-modal="true">
            <div class="mb-6 p-4 bg-blue-900/20 rounded-full">
                <i data-lucide="trending-up" class="w-16 h-16 text-blue-400"></i>
            </div>
            <h2 id="login-title" class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500 mb-2">Plataforma BBP</h2>
            <p class="text-gray-500 mb-8 text-center text-sm">Terminal de Gestión de Activos Digitales</p>
            
            <div class="w-full space-y-5">
                <!-- Input de Nombre -->
                <div>
                    <label for="input-name" class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1">Identidad del Operador</label>
                    <input type="text" id="input-name" placeholder="Nombre Completo" class="w-full p-4 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 outline-none" required>
                </div>

                <!-- Input de RUT -->
                <div>
                    <label for="input-rut" class="block text-xs font-medium text-gray-400 uppercase tracking-wider mb-1">RUT / ID Fiscal</label>
                    <input type="text" id="input-rut" placeholder="Ej: 11.222.333-K" class="w-full p-4 bg-gray-800 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-150 outline-none" required>
                </div>
                
                <p id="login-message" class="text-center text-sm font-medium h-5 transition-all duration-300"></p>

                <!-- Botón de Acceso -->
                <button id="login-button" class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-500 hover:to-indigo-600 text-white font-bold py-4 rounded-xl transition duration-300 shadow-lg mt-2 transform hover:scale-[1.02]">
                    Inicializar Sistema
                </button>
            </div>
        </section>

        <!-- Contenido Principal Visible por defecto (Inicialmente oculto) -->
        <div id="content-container" class="space-y-8 mt-4 hidden">
            
            <!-- Encabezado de la Aplicación -->
            <header class="flex flex-col md:flex-row justify-between items-center p-4 bg-gray-900 rounded-lg shadow-xl border-b border-gray-800">
                <div class="flex items-center space-x-3 mb-4 md:mb-0">
                    <div class="p-2 bg-blue-600 rounded-lg">
                        <span class="font-bold text-white">BBP</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">Terminal de Trading</h1>
                        <p class="text-xs text-gray-500">Conexión Segura Establecida</p>
                    </div>
                </div>
                
                <!-- Info de Usuario y Botón de Salir -->
                <div class="flex items-center space-x-4 bg-gray-800 p-2 rounded-lg">
                    <div class="flex flex-col text-right mr-2">
                        <span id="user-name-display" class="text-sm font-semibold text-gray-200">Usuario</span>
                        <span id="user-rut-display" class="text-xs text-gray-500">ID</span>
                    </div>
                    <button id="logout-button" class="p-2 bg-red-900/50 hover:bg-red-600 text-red-200 hover:text-white rounded-lg transition duration-200 flex items-center" title="Cerrar Sesión">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </header>

            <!-- Grid Principal -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Columna Izquierda: Gráfico (Ocupa 2 columnas en pantallas grandes) -->
                <div class="lg:col-span-2 space-y-8">
                    
                    <!-- Gráfico Histórico -->
                    <section id="chart-section" class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                                <i data-lucide="bar-chart-2" class="text-blue-400"></i>
                                Rendimiento Histórico
                            </h2>
                            
                            <div class="flex flex-wrap gap-2">
                                <!-- Controles Tipo -->
                                <div class="bg-gray-900 rounded-lg p-1 flex">
                                    <button onclick="updateChartType('line', this)" class="chart-control active px-3 py-1 text-xs rounded hover:bg-gray-700 transition">Línea</button>
                                    <button onclick="updateChartType('bar', this)" class="chart-control px-3 py-1 text-xs rounded hover:bg-gray-700 transition">Barras</button>
                                </div>
                                <!-- Controles Escala -->
                                <div class="bg-gray-900 rounded-lg p-1 flex">
                                    <button onclick="updateChartScale('logarithmic', this)" class="scale-control active px-3 py-1 text-xs rounded hover:bg-gray-700 transition">Log</button>
                                    <button onclick="updateChartScale('linear', this)" class="scale-control px-3 py-1 text-xs rounded hover:bg-gray-700 transition">Lineal</button>
                                </div>
                            </div>
                        </div>

                        <div class="h-[400px] w-full relative">
                            <canvas id="bbpChart"></canvas>
                        </div>
                        <p class="text-center text-xs text-gray-500 mt-4">Datos generados desde el inicio del activo hasta el día de hoy.</p>
                    </section>

                    <!-- Panel de Trading -->
                    <section id="trading-section" class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700 relative overflow-hidden">
                        <!-- Efecto de fondo para alertas -->
                        <div id="alert-overlay" class="absolute inset-0 pointer-events-none opacity-0 transition-opacity duration-300 bg-red-900/20 z-0"></div>
                        
                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
                                <i data-lucide="arrow-left-right" class="text-green-400"></i>
                                Ejecución de Órdenes
                            </h2>

                            <div class="grid md:grid-cols-2 gap-8">
                                <!-- Indicadores -->
                                <div class="space-y-4">
                                    <!-- Precio Actual -->
                                    <div class="bg-gray-900 p-4 rounded-xl border border-gray-700 text-center relative overflow-hidden group">
                                        <div class="absolute top-0 left-0 w-1 h-full bg-yellow-500 transition-colors duration-300" id="price-indicator-bar"></div>
                                        <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">Precio de Mercado ($BBP)</p>
                                        <p id="price-display" class="text-5xl font-mono font-bold text-white tracking-tight transition-all duration-100">$4.00</p>
                                        <span id="trend-indicator" class="text-xs font-bold px-2 py-1 rounded bg-gray-800 mt-2 inline-block">ESTABLE</span>
                                    </div>

                                    <!-- Saldos -->
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                                            <p class="text-xs text-gray-400">USD Disponibles</p>
                                            <div class="flex justify-between items-end">
                                                <p id="capital-display" class="text-xl font-bold text-green-400 truncate">$1,000.00</p>
                                                <button onclick="copyToClipboard('capital-display')" class="text-gray-500 hover:text-white"><i data-lucide="copy" class="w-4 h-4"></i></button>
                                            </div>
                                        </div>
                                        <div class="bg-gray-900 p-3 rounded-lg border border-gray-700">
                                            <p class="text-xs text-gray-400">BBP en Cartera</p>
                                            <div class="flex justify-between items-end">
                                                <p id="bbp-holding-display" class="text-xl font-bold text-blue-400 truncate">0.0000</p>
                                                <button onclick="copyToClipboard('bbp-holding-display')" class="text-gray-500 hover:text-white"><i data-lucide="copy" class="w-4 h-4"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Controles de Orden -->
                                <div class="flex flex-col justify-between">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">Monto de Operación</label>
                                        <div class="relative">
                                            <input type="number" id="trade-input" placeholder="0.00" min="0" class="w-full p-4 bg-gray-900 border border-gray-600 rounded-lg text-white text-right font-mono text-xl focus:ring-2 focus:ring-blue-500 outline-none transition-colors">
                                            <span class="absolute left-4 top-4 text-gray-500 font-mono">VALOR</span>
                                        </div>
                                        <!-- Previsualización dinámica -->
                                        <div class="mt-2 text-right h-5">
                                            <p id="preview-conversion" class="text-xs text-blue-300 font-mono"></p>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-3 mt-4">
                                        <button id="btn-buy" class="bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-lg transition duration-200 shadow-lg flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                            <span>COMPRAR</span>
                                            <i data-lucide="trending-up" class="w-4 h-4"></i>
                                        </button>
                                        <button id="btn-sell" class="bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-lg transition duration-200 shadow-lg flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                            <span>VENDER</span>
                                            <i data-lucide="trending-down" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                    <p id="trade-message" class="mt-3 text-center text-xs font-bold h-4 text-transparent transition-all duration-300">.</p>
                                </div>
                            </div>
                        </section>
                    </div>

                    <!-- Columna Derecha: Análisis e Historial Diario -->
                    <div class="space-y-8">
                        
                        <!-- Análisis Fundamental -->
                        <section class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                            <h3 class="text-lg font-bold text-teal-400 mb-4 border-b border-gray-700 pb-2">Análisis de Mercado</h3>
                            <div class="space-y-4 text-sm text-gray-300">
                                <p>
                                    <span class="bg-blue-900 text-blue-200 px-2 py-0.5 rounded text-xs font-bold">ACTIVO MEME</span>
                                    Valor ligado a la viralidad ("Brainrot Italian") y sentimiento social.
                                </p>
                                <ul class="space-y-2 mt-2">
                                    <li class="flex items-start gap-2">
                                        <span class="w-2 h-2 mt-1.5 rounded-full bg-yellow-400 flex-shrink-0"></span>
                                        <span><strong>Agosto:</strong> Lanzamiento y explosión viral.</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="w-2 h-2 mt-1.5 rounded-full bg-red-400 flex-shrink-0"></span>
                                        <span><strong>Septiembre:</strong> Corrección masiva por falta de atención.</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="w-2 h-2 mt-1.5 rounded-full bg-green-400 flex-shrink-0"></span>
                                        <span><strong>Oct - Hoy:</strong> Recuperación y volatilidad extrema.</span>
                                    </li>
                                </ul>
                                <div class="bg-yellow-900/30 p-3 rounded border border-yellow-700/50 mt-2">
                                    <p class="text-yellow-200 text-xs">
                                        <strong>Estrategia:</strong> Comprar en rangos bajos ($3-$5) y vender inmediatamente durante los picos de volatilidad ($300+).
                                    </p>
                                </div>
                            </div>
                        </section>

                        <!-- Tabla Histórica Diaria -->
                        <section class="bg-gray-800 rounded-xl shadow-2xl border border-gray-700 flex flex-col h-[500px]">
                            <div class="p-4 border-b border-gray-700 bg-gray-850 rounded-t-xl">
                                <h3 class="text-lg font-bold text-white">Histórico Diario</h3>
                                <p class="text-xs text-gray-500">Promedios calculados hasta hoy</p>
                            </div>
                            
                            <div class="flex-1 overflow-y-auto p-0">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-gray-900 sticky top-0 z-10 shadow-md">
                                        <tr>
                                            <th class="py-3 px-4 text-xs font-medium text-gray-400 uppercase">Fecha</th>
                                            <th class="py-3 px-4 text-xs font-medium text-gray-400 uppercase text-right">Precio Prom.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="daily-average-table-body" class="divide-y divide-gray-700 text-sm">
                                        <!-- Datos inyectados por JS -->
                                    </tbody>
                                </table>
                            </div>
                        </section>
                    </div>

            </div>
        </div>
    </div>

    <script type="module">
        // =================================================================
        // Configuración e Inicialización
        // =================================================================
        lucide.createIcons();

        // Variables Globales
        let bbpChart;
        let currentChartType = 'line';
        let currentScaleType = 'logarithmic';
        let historicalData = { labels: [], values: [] };

        // Estado del Usuario y Mercado
        let userName = '';
        let userRUT = '';
        let capital = 1000.00;
        let bbpHolding = 0.0000;
        
        let currentPrice = 4.00;
        let isSpiking = false;
        let marketInterval;

        // Constantes de Simulación
        const PRICE_NORMAL_MIN = 3.00;
        const PRICE_NORMAL_MAX = 6.50;
        const PRICE_SPIKE_MIN = 150.00;
        const PRICE_SPIKE_MAX = 850.00;
        const PROBABILITY_OF_SPIKE = 0.15; // Probabilidad de pico en cada tick (ajustado para jugabilidad)
        const TICK_SPEED = 2000; // ms

        // =================================================================
        // 1. Generación de Datos Históricos (FIX: Hasta HOY)
        // =================================================================
        function generateHistoricalData() {
            const labels = [];
            const values = [];
            
            // Fecha de inicio: 1 de Agosto de 2024 (según la historia)
            const startDate = new Date('2024-08-01');
            const today = new Date(); // Fecha actual del sistema
            
            let currentDate = new Date(startDate);
            
            while (currentDate <= today) {
                // Formato de etiqueta
                const dateLabel = currentDate.toLocaleDateString('es-CL', { day: 'numeric', month: 'short' });
                labels.push(dateLabel);

                // Lógica de precio basada en la "Historia" del activo
                const month = currentDate.getMonth(); // 7 = Agosto, 8 = Sept, etc.
                let price;

                if (month === 7) { // AGOSTO: Viralidad extrema
                    // Sube exponencialmente a finales de mes
                    const progress = currentDate.getDate() / 31;
                    price = 5 + (Math.pow(100, progress * 2)); 
                    if (currentDate.getDate() > 15) price += Math.random() * 500;
                } else if (month === 8) { // SEPTIEMBRE: El Crash
                    // Cae dramáticamente
                    const progress = currentDate.getDate() / 30;
                    price = 10000 * Math.exp(-progress * 8) + 4;
                } else { // OCTUBRE en adelante: Volatilidad Lateral
                    // Random walk con picos ocasionales
                    price = 4 + (Math.random() * 3);
                    if (Math.random() > 0.9) price += Math.random() * 50; // Pico pequeño histórico
                }

                // Asegurar que no sea negativo ni cero
                price = Math.max(0.01, price);
                values.push(price);

                // Avanzar un día
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // El último valor debe coincidir aproximadamente con el precio actual de inicio
            values[values.length - 1] = currentPrice;

            return { labels, values };
        }

        // =================================================================
        // 2. Gestión de Gráficos
        // =================================================================
        window.initChart = function() {
            if (bbpChart) bbpChart.destroy();

            const ctx = document.getElementById('bbpChart').getContext('2d');
            const generated = generateHistoricalData();
            historicalData = generated; // Guardar para uso global

            // Rellenar la tabla con estos datos (invertida para ver lo más reciente arriba)
            populateHistoryTable(generated);

            bbpChart = new Chart(ctx, {
                type: currentChartType,
                data: {
                    labels: generated.labels,
                    datasets: [{
                        label: 'Precio BBP (USD)',
                        data: generated.values,
                        borderColor: '#3b82f6',
                        backgroundColor: currentChartType === 'bar' ? '#3b82f6' : 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0, // Ocultar puntos para limpieza visual
                        pointHoverRadius: 4,
                        fill: currentChartType === 'line',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#1f2937', drawBorder: false },
                            ticks: { color: '#9ca3af', maxTicksLimit: 10 }
                        },
                        y: {
                            type: currentScaleType,
                            grid: { color: '#1f2937', drawBorder: false },
                            ticks: { 
                                color: '#9ca3af',
                                callback: function(value) {
                                    if (value >= 1000) return '$' + value/1000 + 'k';
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        };

        window.updateChartType = function(type, btn) {
            currentChartType = type;
            // Actualizar UI botones
            document.querySelectorAll('.chart-control').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Actualizar Chart
            bbpChart.config.type = type;
            bbpChart.data.datasets[0].fill = (type === 'line');
            bbpChart.data.datasets[0].backgroundColor = type === 'bar' ? '#3b82f6' : 'rgba(59, 130, 246, 0.1)';
            bbpChart.update();
        };

        window.updateChartScale = function(scale, btn) {
            currentScaleType = scale;
            // Actualizar UI botones
            document.querySelectorAll('.scale-control').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Actualizar Chart
            bbpChart.options.scales.y.type = scale;
            bbpChart.update();
        };

        function populateHistoryTable(data) {
            const tbody = document.getElementById('daily-average-table-body');
            tbody.innerHTML = '';
            
            // Crear copia para invertir sin afectar el gráfico
            const reversedLabels = [...data.labels].reverse();
            const reversedValues = [...data.values].reverse();

            reversedLabels.forEach((date, index) => {
                const price = reversedValues[index];
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-700 transition-colors';
                
                let colorClass = 'text-white';
                if(price > 100) colorClass = 'text-green-400 font-bold';
                if(price < 1) colorClass = 'text-red-400';

                tr.innerHTML = `
                    <td class="py-2 px-4 text-gray-300 border-b border-gray-800">${date}</td>
                    <td class="py-2 px-4 text-right border-b border-gray-800 font-mono ${colorClass}">
                        $${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // =================================================================
        // 3. Lógica de Mercado en Tiempo Real
        // =================================================================
        function startMarket() {
            updateMarketDisplay();
            
            marketInterval = setInterval(() => {
                // Lógica de precios
                if (isSpiking) {
                    // Si ya estamos en un pico, volvemos a la normalidad
                    isSpiking = false;
                    currentPrice = getRandomPrice(PRICE_NORMAL_MIN, PRICE_NORMAL_MAX);
                    showTrend('NORMAL', 'text-blue-400');
                    document.getElementById('alert-overlay').classList.remove('opacity-100');
                } else {
                    // Decidir si hay pico
                    if (Math.random() < PROBABILITY_OF_SPIKE) {
                        isSpiking = true;
                        currentPrice = getRandomPrice(PRICE_SPIKE_MIN, PRICE_SPIKE_MAX);
                        showTrend('¡PUMP!', 'text-red-500');
                        document.getElementById('alert-overlay').classList.add('opacity-100');
                        showMessage("¡VOLATILIDAD EXTREMA DETECTADA!", "text-red-500");
                    } else {
                        // Fluctuación normal
                        const change = (Math.random() - 0.5) * 0.5; // +/- 0.25
                        currentPrice += change;
                        currentPrice = Math.max(0.01, currentPrice); // Nunca negativo
                        showTrend('ESTABLE', 'text-gray-400');
                    }
                }

                // Actualizar UI
                updateMarketDisplay();
                
                // Actualizar último punto del gráfico en tiempo real (opcional, aquí solo actualizamos el valor visual)
                // Si quisiéramos el gráfico "vivo", haríamos push al dataset.
                
            }, TICK_SPEED);
        }

        function updateMarketDisplay() {
            const priceEl = document.getElementById('price-display');
            const barEl = document.getElementById('price-indicator-bar');
            
            priceEl.textContent = `$${currentPrice.toFixed(2)}`;
            
            if(isSpiking) {
                priceEl.classList.add('text-red-500');
                priceEl.classList.remove('text-white');
                barEl.className = 'absolute top-0 left-0 w-1 h-full bg-red-500 transition-colors duration-300';
            } else {
                priceEl.classList.remove('text-red-500');
                priceEl.classList.add('text-white');
                barEl.className = 'absolute top-0 left-0 w-1 h-full bg-green-500 transition-colors duration-300';
            }

            // Recalcular preview si hay un valor en el input
            calculatePreview();
        }

        function showTrend(text, colorClass) {
            const el = document.getElementById('trend-indicator');
            el.textContent = text;
            el.className = `text-xs font-bold px-2 py-1 rounded bg-gray-900 mt-2 inline-block ${colorClass}`;
        }

        function getRandomPrice(min, max) {
            return Math.random() * (max - min) + min;
        }

        // =================================================================
        // 4. Trading e Interacción
        // =================================================================
        
        // Input listener para previsualización
        document.getElementById('trade-input').addEventListener('input', calculatePreview);

        function calculatePreview() {
            const inputVal = parseFloat(document.getElementById('trade-input').value);
            const previewEl = document.getElementById('preview-conversion');
            
            if (!inputVal || inputVal <= 0) {
                previewEl.textContent = '';
                return;
            }

            // Asumimos que el input es "Cantidad de USD" para comprar, o "Cantidad de BBP" para vender
            // Pero para simplificar UX, haremos:
            // Botón Comprar: Input es USD -> Recibes BBP
            // Botón Vender: Input es BBP -> Recibes USD
            // Mostraremos ambos en el preview
            
            const bbpToReceive = inputVal / currentPrice;
            const usdToReceive = inputVal * currentPrice;

            previewEl.innerHTML = `
                Si compras con $${inputVal}: <span class="text-white">${bbpToReceive.toFixed(4)} BBP</span><br>
                Si vendes ${inputVal} BBP: <span class="text-green-400">$${usdToReceive.toFixed(2)}</span>
            `;
        }

        // Comprar
        document.getElementById('btn-buy').addEventListener('click', () => {
            const amount = parseFloat(document.getElementById('trade-input').value);
            if (!amount || amount <= 0) {
                showMessage('Ingrese un monto válido', 'text-yellow-500');
                return;
            }
            
            if (amount > capital) {
                showMessage('Fondos insuficientes', 'text-red-500');
                return;
            }

            // Ejecutar compra
            capital -= amount;
            const bbpBought = amount / currentPrice;
            bbpHolding += bbpBought;
            
            updatePortfolioUI();
            showMessage(`¡Compra Exitosa! +${bbpBought.toFixed(4)} BBP`, 'text-green-400');
            document.getElementById('trade-input').value = '';
            calculatePreview();
        });

        // Vender
        document.getElementById('btn-sell').addEventListener('click', () => {
            const amountBBP = parseFloat(document.getElementById('trade-input').value);
             if (!amountBBP || amountBBP <= 0) {
                showMessage('Ingrese cantidad de BBP', 'text-yellow-500');
                return;
            }

            if (amountBBP > bbpHolding) {
                showMessage('No tienes suficientes BBP', 'text-red-500');
                return;
            }

            // Ejecutar venta
            bbpHolding -= amountBBP;
            const usdReceived = amountBBP * currentPrice;
            capital += usdReceived;

            updatePortfolioUI();
            showMessage(`¡Venta Exitosa! +$${usdReceived.toFixed(2)}`, 'text-green-400');
            document.getElementById('trade-input').value = '';
            calculatePreview();
        });

        function updatePortfolioUI() {
            document.getElementById('capital-display').textContent = '$' + capital.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('bbp-holding-display').textContent = bbpHolding.toFixed(4);
        }

        function showMessage(msg, colorClass) {
            const el = document.getElementById('trade-message');
            el.textContent = msg;
            el.className = `mt-3 text-center text-xs font-bold h-4 transition-all duration-300 ${colorClass}`;
            
            // Limpiar después de 3 seg
            setTimeout(() => {
                if(el.textContent === msg) {
                    el.textContent = '.';
                    el.classList.add('text-transparent');
                }
            }, 3000);
        }

        // =================================================================
        // 5. Gestión de Acceso (Login/Logout)
        // =================================================================
        
        document.getElementById('login-button').addEventListener('click', () => {
            const name = document.getElementById('input-name').value.trim();
            const rut = document.getElementById('input-rut').value.trim();
            const msg = document.getElementById('login-message');

            if (!name || !rut) {
                msg.textContent = 'Complete todos los campos.';
                msg.className = 'text-center text-sm font-medium h-5 text-red-400';
                return;
            }

            // Login exitoso
            userName = name;
            userRUT = rut;

            // UI Updates
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('content-container').classList.remove('hidden');
            
            document.getElementById('user-name-display').textContent = userName;
            document.getElementById('user-rut-display').textContent = userRUT;

            // Inicializar sistema
            updatePortfolioUI();
            window.initChart();
            startMarket();
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            // Detener mercado
            clearInterval(marketInterval);
            
            // Reset UI
            document.getElementById('content-container').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
            
            // Reset Inputs
            document.getElementById('input-name').value = '';
            document.getElementById('input-rut').value = '';
            document.getElementById('trade-input').value = '';
            
            // Reset Data
            capital = 1000;
            bbpHolding = 0;
            document.getElementById('login-message').textContent = '';
        });

        // Utilidad Global
        window.copyToClipboard = function(id) {
            const text = document.getElementById(id).textContent.replace('$','').replace(',','');
            navigator.clipboard.writeText(text).then(() => {
                showMessage('¡Copiado!', 'text-blue-400');
            });
        };

    </script>
</body>
</html>